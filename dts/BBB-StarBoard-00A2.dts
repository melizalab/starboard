/dts-v1/;
/plugin/;

/ {
  compatible = "ti,beaglebone-black";

  /* identification */
  part-number = "BBB-StarBoard";
  version = "00A2";

  exclusive-use =
      "P8.11", /* pru0: pr1_pru0_pru_r30_15 */
      "P8.12", /* pru0: pr1_pru0_pru_r30_14 */
      "pru0",
      "P8.13", "ehrpwm2b", /* "gpio0_23", */
      "P8.14", "gpio0_26",
      "P8.15", "gpio1_15",
      "P8.16", "gpio1_14",
      "P8.17", "gpio0_27",
      "P8.18", "gpio2_1",
      "P8.19", "gpio0_22",
      "P8.26", "gpio1_29",
      "P8.41", "gpio2_10",
      "P8.42", "gpio2_11",
      "P8.43", "gpio2_8",
      "P8.44", "gpio2_9",
      "P8.45", "gpio2_6",
      "P8.46", "gpio2_7",
      "P9.25", "P9.28", "P9.29", "P9.31", "mcasp0", "ssm2518",
      "P9.27", "gpio3_19", "gpio1_27";

  /* sets pin mux */
  fragment@0 {
    target = <&am33xx_pinmux>;
    __overlay__ {
      lights_pwm: pinmux_lights_pwm_pins {
        pinctrl-single,pins = <
             0x024 0x4 /* P8.13 - house lights output pulldown */
        >;
      };
      hopper_pru: pinmux_hopper_pru_pins {
        pinctrl-single,pins = <
             /* NB: pull up/down state not documented well. 0x06 seems to leave pins in an
                undefined state; 0x26 pulls them down. */
             0x034 0x26 /* P8.11 - right hopper PRU0 output pulldown */
             0x030 0x26 /* P8.12 - left hopper PRU0 output pulldown */
        >;
      };
      led_gpio: pinmux_led_gpio_pins {
        pinctrl-single,pins = <
             0x08c 0x07 /* P8.18 - right green */
             0x020 0x07 /* P8.19 - right blue */
             0x07c 0x07 /* P8.26 - right red */
             0x0b0 0x07 /* P8.41 - center green */
             0x0b4 0x07 /* P8.42 - center blue */
             0x0a8 0x07 /* P8.43 - left blue */
             0x0ac 0x07 /* P8.44 - center red */
             0x0a0 0x07 /* P8.45 - left red */
             0x0a4 0x07 /* P8.46 - left green */
        >;
      };
      keys_gpio: pinmux_keys_gpio_pins {
        pinctrl-single,pins = <
             0x028 0x37 /* P8.14 - right peck */
             0x03c 0x37 /* P8.15 - center peck */
             0x02c 0x37 /* P8.17 - left peck */
        >;
      };
      hopdet_gpio: pinmux_hopdet_gpio_pins {
        pinctrl-single,pins = <
             0x038 0x37 /* P8.16 - hopper up */
        >;
      };
      /* dac_gpio: pinmux_dac_gpio_pins { */
      /*   pinctrl-single,pins = < */
      /*   >; */
      /* }; */
      mcasp0_pins: mcasp0_pins {
        pinctrl-single,pins = <
          0x190 0x20    /* P9.31 mode 2: mcasp0_aclkx */
          0x194 0x20    /* P9.29 mcasp0_fsx */
          0x198 0x20    /* P9.30 mcasp0_axr0 (not used) */
          0x19c 0x22    /* P9.28 mcasp0_axr2 (tx) */
          0x1ac 0x30    /* P9.25 mcasp0_ahclkx (input?) */
          0x1a8 0x1f    /* GPIO1_27 - enable clock on P9.25 */
          0x1a4 0x17    /* P9.27 - enable/disable SSM2518 dac - active low */
        >;
      };
    };
  };

  /* enables pwm outputs - not sure what first device is but it's needed */
  fragment@1 {
    target = <&epwmss2>;
    __overlay__ {
      status = "okay";
    };
  };

  fragment@2 {
    target = <&ehrpwm2>;
    __overlay__ {
      pinctrl-names = "default";
      pinctrl-0 = <&lights_pwm>;
      status = "okay";
    };
  };

  fragment@3 {
    target = <&mcasp0>;
    __overlay__ {
      pinctrl-names = "default";
      pinctrl-0 = <&mcasp0_pins>;
      status = "okay";

      op-mode = <0>;   /* MCASP_I2S_MODE */
      tdm-slots = <2>;
      num-serializer = <16>;
      /* this corresponds to the axrN channels and what we're using them for */
      serial-dir = <
        0 0 1 0
        0 0 0 0
        0 0 0 0
        0 0 0 0
      >;
      tx-num-evt = <1>;
      rx-num-evt = <1>;
    };
  };

   fragment@4 {
     target = <&i2c2>;
     __overlay__ {
       #address-cells = <1>;
       #size-cells = <0>;

       ssm2518: ssm2518@34 {
                compatible = "adi,ssm2518";
                reg = <0x34>;
                gpios = <&gpio4 19 0>;
                /* gpios = <&gpio3 19 0>; */
                status = "okay";
        };
     };
   };

   fragment@5 {
       target = <&pruss>;
       __overlay__ {
           pinctrl-names = "default";
           pinctrl-0 = <&hopper_pru>;
           status = "okay";
           sbd-hopper-left {
               pin-names = "starboard:hopper:left";
               gpios = <&gpio2 12 0>;
           };
           sbd-hopper-right {
               pin-names = "starboard:hopper:right";
               gpios = <&gpio2 13 0>;
           };
       };
   };

   /* creates user interface */
   fragment@6 {
       target = <&ocp>;
       /* target = <&baseboard_beaglebone_black>; */
       __overlay__ {
         sbd-lights {
                 compatible = "pwm-leds";
                 status = "okay";
                 sbd-lights-pwm {
                         label = "starboard::lights";
                         /*channel, period (ns), polarity */
                         pwms = <&ehrpwm2 1 500000 0>;
                         /* pwm-names = "lights"; */
                         max-brightness = <255>;
                 };
         };
         sbd-cues {
                 compatible = "gpio-leds";
                 pinctrl-names = "default";
                 pinctrl-0 = <&led_gpio>;
                 status = "okay";
                 sbd-cue-rrd {
                         label = "starboard:right:red";
                         gpios = <&gpio2 29 0>; /* P8.26 */
                         default-state = "off";
                 };
                 sbd-cue-rgn {
                         label = "starboard:right:green";
                         gpios = <&gpio3 1 0>; /* P8.18 */
                         default-state = "off";
                 };
                 sbd-cue-rbl {
                         label = "starboard:right:blue";
                         gpios = <&gpio1 22 0>; /* P8.19 */
                         default-state = "off";
                 };
                 sbd-cue-crd {
                         label = "starboard:center:red";
                         gpios = <&gpio3 9 0>; /* P8.44 */
                         default-state = "off";
                 };
                 sbd-cue-cgn {
                         label = "starboard:center:green";
                         gpios = <&gpio3 10 0>; /* P8.41 */
                         default-state = "off";
                 };
                 sbd-cue-cbl {
                         label = "starboard:center:blue";
                         gpios = <&gpio3 11 0>; /* P8.42 */
                         default-state = "off";
                 };
                 sbd-cue-lrd {
                         label = "starboard:left:red";
                         gpios = <&gpio3 6 0>; /* P8.45 */
                         default-state = "off";
                 };
                 sbd-cue-lgn {
                         label = "starboard:left:green";
                         gpios = <&gpio3 7 0>; /* P8.46 */
                         default-state = "off";
                 };
                 sbd-cue-lbl {
                         label = "starboard:left:blue";
                         gpios = <&gpio3 8 0>; /* P8.43 */
                         default-state = "off";
                 };
         };
         sbd-hopdet {
                 compatible = "gpio-keys";
                 pinctrl-names = "default";
                 pinctrl-0 = <&hopdet_gpio>;
                 status = "okay";
                 hopper-up {
                   label = "starboard::hopper-up";
                   debounce_interval = <100>;
                   linux,code = <1>;
                   gpios = <&gpio2 14 0x5>; /* P8.16 */
                   gpio-key,wakeup;
                 };
         };
         sbd-keys {
                 compatible = "gpio-keys";
                 pinctrl-names = "default";
                 pinctrl-0 = <&keys_gpio>;
                 status = "okay";
                 /* these need to be in gpio order for some reason */
                 peck-right {
                   label = "starboard::right-peck";
                   debounce_interval = <5>;
                   linux,code = <4>;
                   gpios = <&gpio1 26 0x5>; /* P8.14 */
                   gpio-key,wakeup;
                 };
                 peck-left {
                   label = "starboard::left-peck";
                   debounce_interval = <5>;
                   linux,code = <2>;
                   /* 0x5 should be input pullup */
                   gpios = <&gpio1 27 0x5>; /* P8.17 */
                   gpio-key,wakeup;
                 };
                 peck-center {
                   label = "starboard::center-peck";
                   debounce_interval = <5>;
                   linux,code = <3>;
                   gpios = <&gpio2 15 0x5>; /* P8.15 */
                   gpio-key,wakeup;
                 };
         };
         sound {
                 compatible = "ti,ssm2518-evm-audio";
                 ti,model = "PMOD AMP3 SSM2518";
                 ti,audio-codec = <&ssm2518>;
                 ti,mcasp-controller = <&mcasp0>;
                 ti,codec-clock-rate = <24576000>;
                 /* enable 24.576 MHz clock from BBB */
                 mcasp_clock_enable = <&gpio2 27 0>;
                 ti,audio-routing =
                         "Speaker Out",       "OUTL",
                         "Speaker Out",       "OUTR";
         };
       };
    };
};
