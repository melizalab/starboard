/dts-v1/;
/plugin/;

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/am33xx.h>

/ {
        fragment@0 {
                target = <&ocp>;
                __overlay__ {
                        P8_11_pinmux { status = "disabled"; }; /* pru0: pr1_pru0_pru_r30_15 */
                        P8_12_pinmux { status = "disabled"; }; /* pru0: pr1_pru0_pru_r30_14 */
                        P8_13_pinmux { status = "disabled"; }; /* ehrpwm2b */
                        P8_14_pinmux { status = "disabled"; }; /* gpio0_26 */
                        P8_15_pinmux { status = "disabled"; }; /* gpio1_15 */
                        P8_16_pinmux { status = "disabled"; }; /* gpio1_14 */
                        P8_17_pinmux { status = "disabled"; }; /* gpio0_27 */
                        P8_18_pinmux { status = "disabled"; }; /* gpio2_1 */
                        P8_19_pinmux { status = "disabled"; }; /* gpio0_22 */
                        P8_26_pinmux { status = "disabled"; }; /* gpio1_29 */
                        P8_41_pinmux { status = "disabled"; }; /* gpio2_10 */
                        P8_42_pinmux { status = "disabled"; }; /* gpio2_8 */
                        P8_43_pinmux { status = "disabled"; }; /* gpio2_9 */
                        P8_44_pinmux { status = "disabled"; }; /* gpio2_6 */
                        P8_45_pinmux { status = "disabled"; }; /* gpio2_7 */
                        P8_46_pinmux { status = "disabled"; }; /* gpio3_19, gpio1_27*/
                        P9_27_pinmux { status = "disabled"; };
                };
        };

        /* sets pin mux */
        fragment@1 {
                target = <&am33xx_pinmux>;
                __overlay__ {
                lights_pwm: pinmux_lights_pwm_pins {
                                pinctrl-single,pins = <
                                        0x024 0x4 /* P8.13 - house lights output pulldown */
                                        >;
                        };
                        /* some j-p to avoid muxing to PRU in its undefined startup state */
                hopper_gpio: pinmux_hopper_gpio_pins {
                                pinctrl-single,pins = <
                                        0x34 0x27
                                        0x30 0x27
                                        >;
                        };
                hopper_pru: pinmux_hopper_pru_pins {
                                pinctrl-single,pins = <
                                        0x34 0x26
                                        0x30 0x26
                                        >;
                        };
                led_gpio: pinmux_led_gpio_pins {
                                pinctrl-single,pins = <
                                        0x08c 0x07 /* P8.18 - right green */
                                        0x020 0x07 /* P8.19 - right blue */
                                        0x07c 0x07 /* P8.26 - right red */
                                        0x0b0 0x07 /* P8.41 - center green */
                                        0x0b4 0x07 /* P8.42 - center blue */
                                        0x0a8 0x07 /* P8.43 - left blue */
                                        0x0ac 0x07 /* P8.44 - center red */
                                        0x0a0 0x07 /* P8.45 - left red */
                                        0x0a4 0x07 /* P8.46 - left green */
                                        >;
                        };
                keys_gpio: pinmux_keys_gpio_pins {
                                pinctrl-single,pins = <
                                        0x028 0x37 /* P8.14 - right peck */
                                        0x03c 0x37 /* P8.15 - center peck */
                                        0x02c 0x37 /* P8.17 - left peck */
                                        >;
                        };
                hopdet_gpio: pinmux_hopdet_gpio_pins {
                                pinctrl-single,pins = <
                                        0x038 0x37 /* P8.16 - hopper up */
                                        >;
                        };
                };
        };

        /* enables pwm outputs - not sure what first device is but it's needed */
        fragment@2 {
                target = <&epwmss2>;
                __overlay__ {
                        status = "okay";
                };
        };

        fragment@3 {
                target = <&ehrpwm2>;
                __overlay__ {
                        pinctrl-names = "default";
                        pinctrl-0 = <&lights_pwm>;
                        status = "okay";
                };
        };

  //  fragment@4 {
  //      target = <&pruss>;
  //      __overlay__ {
  //          status = "okay";
  //      };
  //  };

   /* creates user interface */
   fragment@4 {
           target-path = "/";
           __overlay__ {
                   sbd-lights {
                           compatible = "pwm-leds";
                           status = "okay";
                           sbd-lights-pwm {
                                   label = "starboard::lights";
                                   /*channel, period (ns), polarity */
                                   pwms = <&ehrpwm2 1 500000 0>;
                                   /* pwm-names = "lights"; */
                                   max-brightness = <255>;
                           };
                   };
         // sbd-hoppers {
         //         compatible = "bone-pinmux-helper";
         //         status = "okay";
         //         pinctrl-names = "default", "pruout";
         //         pinctrl-0 = <&hopper_gpio>;
         //         pinctrl-1 = <&hopper_pru>;
         // };
                   sbd-hopper-gpio {
                           compatible = "gpio-leds";
                           status = "okay";
                           sbd-hopper-left {
                                   label = "starboard:hopper:left";
                                   gpios = <&gpio2 12 0>;
                                   default-state = "off";
                           };
                           sbd-hopper-right {
                                   label = "starboard:hopper:right";
                                   gpios = <&gpio2 13 0>;
                                   default-state = "off";
                           };
                   };
                   sbd-cues {
                           compatible = "gpio-leds";
                           pinctrl-names = "default";
                           pinctrl-0 = <&led_gpio>;
                           status = "okay";
                           sbd-cue-rrd {
                                   label = "starboard:right:red";
                                   gpios = <&gpio2 29 0>; /* P8.26 */
                                   default-state = "off";
                           };
                           sbd-cue-rgn {
                                   label = "starboard:right:green";
                                   gpios = <&gpio3 1 0>; /* P8.18 */
                                   default-state = "off";
                           };
                           sbd-cue-rbl {
                                   label = "starboard:right:blue";
                                   gpios = <&gpio1 22 0>; /* P8.19 */
                                   default-state = "off";
                           };
                           sbd-cue-crd {
                                   label = "starboard:center:red";
                                   gpios = <&gpio3 9 0>; /* P8.44 */
                                   default-state = "off";
                           };
                           sbd-cue-cgn {
                                   label = "starboard:center:green";
                                   gpios = <&gpio3 10 0>; /* P8.41 */
                                   default-state = "off";
                           };
                           sbd-cue-cbl {
                                   label = "starboard:center:blue";
                                   gpios = <&gpio3 11 0>; /* P8.42 */
                                   default-state = "off";
                           };
                           sbd-cue-lrd {
                                   label = "starboard:left:red";
                                   gpios = <&gpio3 6 0>; /* P8.45 */
                                   default-state = "off";
                           };
                           sbd-cue-lgn {
                                   label = "starboard:left:green";
                                   gpios = <&gpio3 7 0>; /* P8.46 */
                                   default-state = "off";
                           };
                           sbd-cue-lbl {
                                   label = "starboard:left:blue";
                                   gpios = <&gpio3 8 0>; /* P8.43 */
                                   default-state = "off";
                           };
                   };
                   sbd-hopdet {
                           compatible = "gpio-keys";
                           pinctrl-names = "default";
                           pinctrl-0 = <&hopdet_gpio>;
                           status = "okay";
                           hopper-up {
                                   label = "starboard::hopper-up";
                                   debounce_interval = <100>;
                                   linux,code = <1>;
                                   gpios = <&gpio2 14 0x5>; /* P8.16 */
                                   gpio-key,wakeup;
                           };
                   };
                   sbd-keys {
                           compatible = "gpio-keys";
                           pinctrl-names = "default";
                           pinctrl-0 = <&keys_gpio>;
                           status = "okay";
                           /* these need to be in gpio order for some reason */
                           peck-right {
                                   label = "starboard::right-peck";
                                   debounce_interval = <5>;
                                   linux,code = <4>;
                                   gpios = <&gpio1 26 0x5>; /* P8.14 */
                                   gpio-key,wakeup;
                           };
                           peck-left {
                                   label = "starboard::left-peck";
                                   debounce_interval = <5>;
                                   linux,code = <2>;
                                   /* 0x5 should be input pullup */
                                   gpios = <&gpio1 27 0x5>; /* P8.17 */
                                   gpio-key,wakeup;
                           };
                           peck-center {
                                   label = "starboard::center-peck";
                                   debounce_interval = <5>;
                                   linux,code = <3>;
                                   gpios = <&gpio2 15 0x5>; /* P8.15 */
                                   gpio-key,wakeup;
                           };
                   };
           };
   };
 };
